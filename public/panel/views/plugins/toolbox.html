<!--
Name: 系统工具箱
-->
<title>系统工具箱</title>
<div class="layui-fluid" id="component-tabs">
    <div class="layui-row">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">系统工具箱</div>
                <div class="layui-card-body">
                    <div class="layui-tab">
                        <ul class="layui-tab-title">
                            <li class="layui-this">DNS</li>
                            <li>SWAP</li>
                            <li>Hosts</li>
                            <li>时区</li>
                            <li>Root密码</li>
                        </ul>
                        <div class="layui-tab-content">
                            <div class="layui-tab-item layui-show">
                                <div class="layui-form" lay-filter="toolbox-dns">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" style="font-size: 13px;">DNS 1</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="dns1" value="获取中ing..."
                                                   class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">修改 DNS 1</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" style="font-size: 13px;">DNS 2</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="dns2" value="获取中ing..."
                                                   class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">修改 DNS 2</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <button class="layui-btn layui-btn-sm" lay-submit
                                                    lay-filter="toolbox-dns-submit">确认修改
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab-item">
                                <blockquote class="layui-elem-quote layui-quote-nm">
                                    总共:
                                    <span class="layui-badge layui-bg-blue"
                                          id="toolbox-swap-total">获取中...</span>
                                </blockquote>
                                <blockquote class="layui-elem-quote layui-quote-nm">
                                    已用:
                                    <span class="layui-badge" id="toolbox-swap-used">获取中...</span>
                                </blockquote>
                                <blockquote class="layui-elem-quote layui-quote-nm">
                                    可用:
                                    <span class="layui-badge layui-bg-green"
                                          id="toolbox-swap-free">获取中...</span>
                                </blockquote>
                                <div class="layui-form" lay-filter="toolbox-swap">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" style="font-size: 13px;">SWAP 大小</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="swap" value="获取中ing..."
                                                   class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">MB</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <button class="layui-btn layui-btn-sm" lay-submit
                                                    lay-filter="toolbox-swap-submit">确认修改
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab-item">
                                <blockquote class="layui-elem-quote">此处修改的是 /etc/hosts 文件。<br>
                                    提示：Ctrl+F 搜索关键字，Ctrl+S 保存，Ctrl+H 查找替换！
                                </blockquote>
                                <div id="toolbox-hosts-editor"
                                     style="height: 600px;"></div>
                                <div class="layui-btn-container" style="padding-top: 30px;">
                                    <button id="toolbox-hosts-save" class="layui-btn">保存</button>
                                </div>
                            </div>
                            <div class="layui-tab-item">
                                <div class="layui-form" lay-filter="toolbox-timezone">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" style="font-size: 13px;">时区</label>
                                        <div class="layui-input-inline">
                                            <script type="text/html" template lay-url="/api/plugins/toolbox/timezone"
                                                    lay-done="layui.data.done(d);">
                                                <select name="timezone">
                                                    {{# layui.each(d.data.zones, function(index, item){ }}
                                                    {{# if(item == d.data.zone){ }}
                                                    <option value="{{ item }}" selected="">{{ item }}</option>
                                                    {{# }else{ }}
                                                    <option value="{{ item }}">{{ item }}</option>
                                                    {{# } }}
                                                    {{# }); }}
                                                </select>
                                            </script>
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">选择一个时区</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <button class="layui-btn layui-btn-sm" lay-submit
                                                    lay-filter="toolbox-timezone-submit">确认修改
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab-item">
                                <div class="layui-form" lay-filter="toolbox-root-password">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label" style="font-size: 13px;">root 密码</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="password" value=""
                                                   class="layui-input" lay-verify="required">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">修改 root 密码</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <button class="layui-btn layui-btn-sm" lay-submit
                                                    lay-filter="toolbox-root-password-submit">确认修改
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let toolbox_hosts_editor;
    layui.use(['jquery', 'admin', 'view', 'form'], function () {
        let $ = layui.$
            , admin = layui.admin
            , form = layui.form;

        form.render();

        admin.req({
            url: "/api/plugins/toolbox/dns"
            , type: 'get'
            , success: function (result) {
                if (result.code !== 0) {
                    return false;
                }
                if (result.data) {
                    form.val('toolbox-dns', {
                        "dns1": result.data[0]
                        , "dns2": result.data[1]
                    });
                }

            }
        });
        form.on('submit(toolbox-dns-submit)', function (data) {
            index = layer.msg('正在修改DNS...', {icon: 16, time: 0, shade: 0.3});
            admin.req({
                url: "/api/plugins/toolbox/dns"
                , type: 'post'
                , data: data.field
                , success: function (result) {
                    layer.close(index)
                    if (result.code !== 0) {
                        return false;
                    }
                    admin.events.refresh();
                    layer.alert('DNS修改成功！');
                }
            });
            return false;
        });

        admin.req({
            url: "/api/plugins/toolbox/swap"
            , type: 'get'
            , success: function (result) {
                if (result.code !== 0) {
                    return false;
                }
                if (result.data) {
                    $('#toolbox-swap-total').html(result.data.total);
                    $('#toolbox-swap-used').html(result.data.used);
                    $('#toolbox-swap-free').html(result.data.free);
                    form.val('toolbox-swap', {
                        "swap": result.data.size
                    });
                }

            }
        });
        form.on('submit(toolbox-swap-submit)', function (data) {
            index = layer.msg('正在修改SWAP...', {icon: 16, time: 0, shade: 0.3});
            admin.req({
                url: "/api/plugins/toolbox/swap"
                , type: 'post'
                , data: {
                    size: data.field.swap
                }
                , success: function (result) {
                    layer.close(index)
                    if (result.code !== 0) {
                        return false;
                    }
                    admin.events.refresh();
                    layer.alert('SWAP修改成功！');
                }
            });
            return false;
        });

        admin.req({
            url: "/api/plugins/toolbox/hosts"
            , type: 'get'
            , success: function (result) {
                if (result.code !== 0) {
                    return false;
                }
                $('#toolbox-hosts-editor').text(result.data);
                toolbox_hosts_editor = ace.edit("toolbox-hosts-editor", {
                    mode: "ace/mode/ini",
                    selectionStyle: "text"
                });
            }
        });
        $('#toolbox-hosts-save').click(function () {
            index = layer.msg('正在保存Hosts...', {icon: 16, time: 0, shade: 0.3});
            admin.req({
                url: "/api/plugins/toolbox/hosts"
                , type: 'post'
                , data: {
                    hosts: toolbox_hosts_editor.getValue()
                }
                , success: function (result) {
                    layer.close(index);
                    if (result.code !== 0) {
                        return false;
                    }
                    layer.alert('Hosts保存成功！');
                }
            });
        });

        form.on('submit(toolbox-root-password-submit)', function (data) {
            index = layer.msg('正在修改root密码...', {icon: 16, time: 0, shade: 0.3});
            admin.req({
                url: "/api/plugins/toolbox/rootPassword"
                , type: 'post'
                , data: data.field
                , success: function (result) {
                    layer.close(index)
                    if (result.code !== 0) {
                        return false;
                    }
                    admin.events.refresh();
                    layer.alert('root密码修改成功！');
                }
            });
            return false;
        });
    });

    layui.data.done = function (d) {
        layui.use(['form', 'admin'], function () {
            let form = layui.form,
                admin = layui.admin;
            form.render(null, 'toolbox-timezone');
            form.on('submit(toolbox-timezone-submit)', function (data) {
                index = layer.msg('正在修改时区...', {icon: 16, time: 0, shade: 0.3});
                admin.req({
                    url: "/api/plugins/toolbox/timezone"
                    , type: 'post'
                    , data: data.field
                    , success: function (result) {
                        layer.close(index)
                        if (result.code !== 0) {
                            return false;
                        }
                        admin.events.refresh();
                        layer.alert('时区修改成功！');
                    }
                });
                return false;
            });
        });
    };
</script>
